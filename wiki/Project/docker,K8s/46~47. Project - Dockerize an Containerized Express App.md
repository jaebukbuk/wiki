---
날짜: 2025-04-01
Objective: 노드 기반(환경)의 간단한 application을 Dockerfile 을 통해서 Image 화 하고 기동해보자
tags:
  - 🐲Project/개발활동/개인서버구축/Docker강의
---
OverVIew 

 - 노드 기반의 간단한 Dockerfile 작성 및 build, run

Details 
# 노드 기반의  Dockfile 
```bash
# enviorment ==> From 을 통해 환경인 baseimage인 node 이미지 그 자체를 선언한다. 
# runtime enviorment 를 선언한다고 생각
# From baseImage:tag
FROM node:22

#Dokcer 컨테이너가 작업되는 공간 ?
WORKDIR /app

# copy the packege.json and package-lock.json
# install the dependencies
# expose the applicaion port
# start application


# copy the packege.json and package-lock.json
# 현재 디렉토리의 json 파일들을 아마 docker컨테이너가 동작하는 /app 으로 옮긴다.
COPY package*.json .

# install dependencies
# pakage*.json 파일에 있는 dependencies 를 내려받는다 
# npm install 의 right 버전
RUN npm ci

# into /app/index.js
COPY src/index.js index.js

#해당 어플리케이션이 3000번을 쓰고 있으니 열어준다.
EXPOSE 3000

CMD [ "node", "index.js" ]
```

- workdir 을 선언 하면 
  ```bash
jaebukbuk@jaebukbukubuntu24:~/containerize-express-app$ docker exec -it 67e5b501ff06 /bin/bash
root@67e5b501ff06:/app#
root@67e5b501ff06:/app# ls
index.js  node_modules  package-lock.json  package.json
root@67e5b501ff06:/app# cd ..
root@67e5b501ff06:/# ls
app  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```
- 다음과 같이 /app 으로 root dir 하위에 app dir 작업공간이 생긴걸 확인할수 있다.
-

```bash
jaebukbuk@jaebukbukubuntu24:~/containerize-express-app$ docker build -t express_app:v0.0.1 .
[+] Building 22.8s (11/11) FINISHED  docker:default
 => [internal] load build definition from Dockerfile
 => => transferring dockerfile: 336B                 
 => [internal] load metadata for docker.io/library/node:22 
 => [auth] library/node:pull token for registry-1.docker.io
 => [internal] load .dockerignore
 => => transferring context: 2B 
 => [1/5] FROM docker.io/library/node:22@sha256:c7fd844945a76eeaa83cb372e4d289b4a30b478a1c80e16c685b62c54  16.4s

...
 sha256:775a325bc2aa2aa75e855af154839b397d850e14c927204905e3f46f718ffb58                   0.0s
 => [internal] load build context
 => => transferring context: 28.34kB
 => [2/5] WORKDIR /app 
 => [3/5] COPY package*.json . 
 => [4/5] RUN npm ci 
 => [5/5] COPY src/index.js index.js 
 => exporting to image
 => => exporting layers
 => => writing image sha256:75ad6404292d1b3dd55e3e835745996b84d0238227add5209878b55fdde086c9 
 => => naming to docker.io/library/express_app:v0.0.1
```
- Dockerfile 명령대로 이미지가 생성된걸 확인할수 있다.
```bash
jaebukbuk@jaebukbukubuntu24:~/containerize-express-app$ docker images                                            
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
express_app   v0.0.1    75ad6404292d   6 seconds ago   1.13GB
```

- 이제 해당 이미지를 실행시키고 테스트 해보면 기존과 같이 잘 작동함을 알수 있다.

# docker pause 
- docker 컨테이너가 실행중일때
```bash
aebukbuk@jaebukbukubuntu24:~/containerize-express-app$ docker start express_app
express_app

jaebukbuk@jaebukbukubuntu24:~$ curl http://localhost:3000
Hello world!
```
- 응답이 잘온다.

- docker 컨테이너가 stop 종료중일떄
```bash
~/containerize-express-app$ docker stop express_app
express_app

~$ curl http://localhost:3000
curl: (7) Failed to connect to localhost port 3000 after 0 ms: Couldn't connect to server
```
- 당연히 실패한다.
- => 당연하지만 docker container 가 사용하는 모든 메모리는 초기화 되므로 재실행 start 했을때 사용했던 메모리 컨테츠는 초기화된다.

- docker 가 일시중지 일때는!? 
```bash
~/containerize-express-app$ docker pause express_app
express_app

~/containerize-express-app$ docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED         STATUS                   PORTS                                       NAMES
9e51cf5407bd   express_app:v0.0.1   "docker-entrypoint.s…"   7 minutes ago   Up 14 seconds (Paused)   0.0.0.0:3000->3000/tcp, :::3000->3000/tcp   express_app

jaebukbuk@jaebukbukubuntu24:~$ curl http://localhost:3000


^C
jaebukbuk@jaebukbukubuntu24:~$ curl -d '{"userId":"jaebukbuk"}' -H "Content-Type: application/json" -X POST localhost:3000/users
^C
```
- 정상적인 요청처리가 안된다. 

- 다시 unpose 로 실행시키면
```bash
~/containerize-express-app$ docker unpause express_app
express_app

~$ curl http://localhost:3000
Hello world!
```
- 잘 동작한다.


# 도커 이미지 삭제시 오류잡기

- 오류 상황! - 도커 이미지 삭제가 안된다!
```bash
~/containerize-express-app$ docker rmi express_app:v0.0.1
Error response from daemon: conflict: unable to remove repository reference "express_app:v0.0.1" (must force) - container 9e51cf5407bd is using its referenced image 75ad6404292d
```
- 이는 해당 이미지를 참조하는 컨테이너가 존재하기 때문이다
  => 컨테이너를 먼저 지우고 이미지를 삭제하라

``` bash
/containerize-express-app$ docker rm express_app
express_app
/containerize-express-app$ docker rmi express_app:v0.0.1
Untagged: express_app:v0.0.1
Deleted: sha256:75ad6404292d1b3dd55e3e835745996b84d0238227add5209878b55fdde086c9
```